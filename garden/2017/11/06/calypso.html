<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" content="前端开发,分享会,投放系统,node.js" />
    <meta name="description" content="阐述我司投放项目的前世今生，应用于内部分享会。" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=0" />
    <title>呆恋小喵的后花园 - Calypso 分享会概要</title>
    <link rel="shortcut icon" href="http://oij8a9ql4.bkt.clouddn.com/shortcut.ico" />
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/8.0/styles/sunburst.min.css" />
    <link rel="stylesheet/less" href="/garden/assets/style/style.less" />
    <script src="https://lib.sinaapp.com/js/jquery/1.9.1/jquery-1.9.1.min.js"></script>
    <script src="https://cdn.bootcss.com/less.js/1.7.0/less.min.js"></script>
    <script src="https://cdn.bootcss.com/highlight.js/8.0/highlight.min.js"></script>
</head>
<body>
<script>
    var pageData = {};
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement('script');
        hm.src = 'https://hm.baidu.com/hm.js?6b9830e6ab8073ce1a44ad49a03d8596';
        var s = document.getElementsByTagName('script')[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>
<img src="http://oij8a9ql4.bkt.clouddn.com/portrait.jpg" alt="呆恋小喵" width="0" height="0" />
<nav>
    <a href="javascript:;" class="js_menu_btn">
        <span></span>
        <span></span>
        <span></span>
    </a>
    <ul class="js_menu">
        <li><a href="/garden/">Home</a></li>
        <li><a href="/garden/views/posts" class="js_goto_posts">Posts</a></li>
        <li><a href="/garden/views/about">About</a></li>
    </ul>
</nav>
<a href="javascript:;" class="gotop js_gotop"></a>
<header class="post" style="background-image: url('http://oij8a9ql4.bkt.clouddn.com/banner.jpg')">
    <div>
        <h2>Calypso 分享会概要</h2>
        <time>06 Nov 2017</time>
        <p class="abstract">阐述我司投放项目的前世今生，应用于内部分享会。</p>
        <ul class="c-fix">
            
            <li>分享会</li>
            
            <li>投放系统</li>
            
            <li>node.js</li>
            
        </ul>
    </div>
</header>
<article class="js_article">
    <p>投放系统如何运作？</p>

<p><img src="http://oy4688ju4.bkt.clouddn.com/calypso.png" alt="" /></p>

<hr />

<p>应用到了哪些工具？</p>

<p><a href="http://nodejs.cn/api/fs.html">NodeJS File System</a></p>

<p><a href="https://github.com/cheeriojs/cheerio">Cheerio</a></p>

<p><a href="https://github.com/steveukx/git-js">Simple Git</a></p>

<p><a href="https://github.com/Unitech/pm2">PM2</a></p>

<p><a href="https://github.com/villadora/express-http-proxy">Express Http Proxy</a></p>

<hr />

<h4 id="主要功能">主要功能</h4>

<h5 id="读取渠道列表">读取渠道列表</h5>

<p><strong>fs.readdir</strong> toufang 文件目录</p>

<p>投放目录默认按字母排序修改为按修改时间倒序：<strong>fs.statSync</strong> 同步读取文件修改时间 <strong>mtime</strong>，避免请求返回先于信息读取，但读取失败会造成阻塞…后期将优化为异步。</p>

<h5 id="添加渠道">添加渠道</h5>

<p><strong>fs.readFile</strong> 模板文件 -&gt; 编辑模板文件流 -&gt; <strong>fs.mkdir</strong> 渠道目录 -&gt; <strong>fs.writeFile</strong> 渠道静态网页文件</p>

<p>编辑模板文件流使用 <a href="https://github.com/cheeriojs/cheerio">Cheerio</a>。</p>

<h5 id="编辑渠道渠道静态网页文件替换">编辑渠道（渠道静态网页文件替换）</h5>

<p><strong>fs.readFile</strong> 模板文件 -&gt; 编辑模板文件流 -&gt; 查找渠道目录 -&gt; <strong>fs.unlink</strong> 渠道静态网页文件 -&gt; <strong>fs.writeFile</strong> 渠道静态网页文件</p>

<p>清洗不规则目录及不规范静态网页文件。</p>

<h5 id="读取图片列表">读取图片列表</h5>

<p><strong>fs.readdir</strong> toufang/upload/images 文件目录</p>

<h5 id="上传图片">上传图片</h5>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">formidable</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'formidable'</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">form</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">formidable</span><span class="p">.</span><span class="nx">IncomingForm</span><span class="p">();</span>
<span class="nx">form</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">fields</span><span class="p">,</span> <span class="nx">files</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// code</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">timestamp</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">valueOf</span><span class="p">();</span>
        <span class="kd">var</span> <span class="nx">filePath</span> <span class="o">=</span> <span class="s1">'upload/images/'</span> <span class="o">+</span> <span class="nx">timestamp</span> <span class="o">+</span> <span class="s1">'_'</span> <span class="o">+</span> <span class="nx">files</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">tmpPath</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">image</span><span class="p">.</span><span class="nx">path</span><span class="p">;</span>
        <span class="kd">var</span> <span class="nx">targetPath</span> <span class="o">=</span> <span class="nx">toufangPath</span> <span class="o">+</span> <span class="nx">filePath</span><span class="p">;</span>
        <span class="nx">fs</span><span class="p">.</span><span class="nx">rename</span><span class="p">(</span><span class="nx">tmpPath</span><span class="p">,</span> <span class="nx">targetPath</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// code</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// code</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<hr />

<h5 id="前端资源入口">前端资源入口</h5>

<div class="language-js highlighter-rouge"><pre class="highlight"><code><span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">express</span><span class="p">.</span><span class="kr">static</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'static'</span><span class="p">)));</span>
</code></pre>
</div>

<p>规定静态资源访问路径，/static 内为前端打包文件资源。__dirname 可获取当前服务所在的完整绝对路径。</p>

<hr />

<h4 id="相关概念">相关概念</h4>

<h5 id="服务器资源同步">服务器资源同步</h5>

<h5 id="进程管理">进程管理</h5>

<h5 id="请求转发">请求转发</h5>

<hr />

<p>作者：呆恋小喵</p>

<p>我的后花园：<a href="https://sunmengyuan.github.io/garden/">https://sunmengyuan.github.io/garden/</a></p>

<p>我的 github：<a href="https://github.com/sunmengyuan">https://github.com/sunmengyuan</a></p>

<p>原文链接：<a href="https://sunmengyuan.github.io/garden/2017/11/06/calypso.html">https://sunmengyuan.github.io/garden/2017/11/06/calypso.html</a></p>

</article>
<footer>
    <a href="/garden/views/posts" class="js_goto_posts">返回目录 - 我的印记</a>
</footer>
<div class="browser js_browser">
    <img src="" />
</div>

<script src="/garden/assets/script/main.js"></script>
</body>
</html>
