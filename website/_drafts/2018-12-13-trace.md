---
layout: post
title: "前端埋点统计方案思考"
date: "2018-12-13"
abstract: "埋点即监控用户在应用表现层的行为，于产品迭代而言至关重要。埋点统计数据分析是产品需求的来源，检验功能是否达预期的佐证，不同产品对埋点数据的关注角度不同...本小白在此将对前端埋点统计方案述说一二。"
keywords: ["埋点"]
thumb: "https://sunmengyuan.github.io/materials/garden/post/trace/thumb.jpg"
---

埋点即监控用户在应用表现层的行为，于产品迭代而言至关重要。埋点统计数据分析是产品需求的来源，检验功能是否达预期的佐证。

根据埋点数据可做如下分析（以百度统计为例）：

![](https://sunmengyuan.github.io/materials/garden/post/trace/baidu.png)

制作各种图表：

![](https://sunmengyuan.github.io/materials/garden/post/trace/chart-line.png)

![](https://sunmengyuan.github.io/materials/garden/post/trace/chart-rect.png)

不同产品对数据的关注角度不同。信息流产品对于停留时长的关注度更高（在进入及离开页面时记录 time 即可），商城类更注重“复购率”（统计新老用户），广告类追求的目标是最大限度。

埋点统计通常分两类：

+ 页面访问量统计

+ 功能点击量统计

*****

### 页面访问量统计

页面访问量统计通常分两类：

+ PV：页面访问人次

+ UV：页面访问人数

页面访问量，并非仅仅取决于页面内容吸引力，影响因素包括页面入口外观、位置、深度等等。入口外观属 UI 设计范畴，入口位置可通过分析用户点击热力图调整，入口深度可通过分析用户访问路径调整。

用户点击热力图形如：

![](https://sunmengyuan.github.io/materials/garden/post/trace/heatmap.jpg)

将核心页面入口置于红色区域？

我们可采集页面访问的 from、to 用于分析用户访问路径：

![](https://sunmengyuan.github.io/materials/garden/post/trace/visit-route.png)

据分析可知用户普遍访问深度、每一级甚至每一页面的访问流失率等，依照分析结果调整核心页面入口源、入口深度？假若发现某一页面的访问量爆跌，便需考虑其访问成功率了（或许是枚技术 bug）。

那么，前端如何实现 PV 的统计，以 Vue 为例：

+ Vue 单例应用：仅单个入口文件，可通过在入口文件全局定义 Router.afterEach 实现全局 PV 统计：

```js
import Router from './router'
import App from './utils/app'

Router.afterEach((to, from) => {
    App.logEvent({
        type: 'visit',
        name: to.name,
        time: new Date().valueOf(),
        params: {
            from: {
                name: from.name,
                path: from.path,
                query: from.query
            },
            to: {
                name: to.name,
                path: to.path,
                query: to.query
            }
        }
    })
})
```

+ Vue 多例应用：含多个入口文件，无法通过全局定义 Router.afterEach 实现全局 PV 统计。可在入口文件全局注册混入 beforeRouteEnter、beforeRouteLeave 对象实现：

```js
import Vue from 'vue'

Vue.mixin({
    beforeRouteEnter (to, from, next) {
        next(vm => {
            vm.$app.logEvent({
                type: 'visit',
                name: to.name,
                time: new Date().valueOf(),
                params: {
                    from: {
                        name: from.name,
                        path: from.path,
                        query: from.query
                    },
                    to: {
                        name: to.name,
                        path: to.path,
                        query: to.query
                    }
                }
            })
        })
    },
    beforeRouteLeave (to, from, next) {
        this.$app.logEvent({
            type: 'visit',
            name: to.name,
            time: new Date().valueOf(),
            params: {
                from: {
                    name: from.name,
                    path: from.path,
                    query: from.query
                },
                to: {
                    name: to.name,
                    path: to.path,
                    query: to.query
                }
            }
        })
        next()
    }
})
```

Vue 单例应用也可采用该方案，且优势在于可统计用户在页面的停留时长。

+ Vue 单例 + Vue 多例混合应用：emmmmmm...那就是采用 Vue 多例应用全局 PV 统计方案。

其中 App.logEvent（this.$app.logEvent）为自定义 Vue 插件 App 中的 method，用于向服务器发起埋点上报请求：

```js
import Request from './utils/request'

const App = {
    // ...
    logEvent (opts) {
        Request({
            url: '/log/event',
            method: 'POST',
            data: {
                type: opts.type,
                name: opts.name,
                time: opts.time,
                params: opts.params || {}
            }
        })
    }
}
App.install = (Vue, options) => {
    Vue.prototype.$app = {
        // ...
        logEvent: App.logEvent
    }
}

export default App
```

+ SSR 应用：为追求更好的 SEO，部分应用采用服务端渲染（SSR）。以 [Jinja（Python 模板）](http://docs.jinkan.org/docs/jinja2/templates.html)为例，调用 TemplateView 则为渲染页面（不同于前后端分离项目，服务端无法获知接口调用与页面渲染的对应关系），统计其调用次数及 TemplateName 可知页面 PV。

*****

